<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Queue - Propload</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <%- include('../partials/header', { 
        user: user, 
        currentPage: 'my-bids',
        bidCount: bidCount || 0
    }) %>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <%- include('../partials/flash-messages') %>

        <!-- Header -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Waiting Queue</h1>
                    <p class="text-gray-600 mt-2">Your bid is in the waiting queue for potential selection</p>
                </div>
                <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                    POSITION <%= bid.queuePosition %>
                </span>
            </div>
            
            <!-- Queue Information -->
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start">
                    <i class="fas fa-clock text-blue-500 text-xl mr-3 mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-blue-800">Waiting Queue Status</h3>
                        <p class="text-blue-700 mt-1">
                            You are position <strong>#<%= bid.queuePosition %></strong> in the waiting queue. 
                            If any of the top 3 bids are marked as defected, you may be promoted automatically.
                        </p>
                        <p class="text-blue-600 text-sm mt-2">
                            The customer has 24 hours to review and select the top 3 bids for Round 2.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Information -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Project: <%= bid.project.title %></h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <p class="text-gray-600"><%= bid.project.description %></p>
                </div>
                <div class="text-sm text-gray-600 space-y-2">
                    <div class="flex justify-between">
                        <span>Your Bid Amount:</span>
                        <span class="font-bold text-green-600">$<%= bid.amount %></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Category:</span>
                        <span class="font-medium capitalize"><%= bid.project.category.replace('-', ' ') %></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Location:</span>
                        <span class="font-medium"><%= bid.project.location.city %>, <%= bid.project.location.state %></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Queue Position:</span>
                        <span class="font-medium text-blue-600">#<%= bid.queuePosition %></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Position Explanation -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">How the Waiting Queue Works</h2>
            
            <div class="space-y-4">
                <div class="flex items-start">
                    <div class="bg-blue-100 text-blue-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-4 mt-1">1</div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Automatic Top 10 Selection</h3>
                        <p class="text-gray-600 text-sm mt-1">
                            After Round 1 ends, the system automatically selects the top 10 lowest bids. The top 3 proceed directly to Round 2, while positions 4-10 enter the waiting queue.
                        </p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="bg-green-100 text-green-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-4 mt-1">2</div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Customer Review Period</h3>
                        <p class="text-gray-600 text-sm mt-1">
                            The customer has 24 hours to review the top 3 bids. They can mark bids as "defected" if there are issues with agreements or proposals.
                        </p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="bg-purple-100 text-purple-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-4 mt-1">3</div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Automatic Promotion</h3>
                        <p class="text-gray-600 text-sm mt-1">
                            If a top 3 bid is defected, the next bidder in the waiting queue (position #4) is automatically promoted to replace them. This process continues as needed.
                        </p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-4 mt-1">4</div>
                    <div>
                        <h3 class="font-semibold text-gray-900">Round 2 Preparation</h3>
                        <p class="text-gray-600 text-sm mt-1">
                            Once 3 valid bids are confirmed, Round 2 begins. Promoted bidders from the waiting queue can then update their bids in the final 24-hour round.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Your Bid Details -->
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Your Bid Details</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Bid Information -->
                <div>
                    <h3 class="font-semibold text-gray-900 mb-3">Bid Summary</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Bid Amount:</span>
                            <span class="font-bold text-green-600">$<%= bid.amount %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Submitted:</span>
                            <span class="font-medium"><%= moment(bid.createdAt).format('MMM D, YYYY h:mm A') %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Queue Position:</span>
                            <span class="font-medium text-blue-600">#<%= bid.queuePosition %></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">WAITING QUEUE</span>
                        </div>
                    </div>
                </div>

                <!-- Next Possible Actions -->
                <div>
                    <h3 class="font-semibold text-gray-900 mb-3">What's Next?</h3>
                    <div class="space-y-2 text-sm text-gray-600">
                        <p class="flex items-start">
                            <i class="fas fa-clock text-blue-500 mr-2 mt-1"></i>
                            <span>Wait for customer to complete top 3 review (24 hours)</span>
                        </p>
                        <p class="flex items-start">
                            <i class="fas fa-user-check text-green-500 mr-2 mt-1"></i>
                            <span>You'll be automatically promoted if a top 3 bid is defected</span>
                        </p>
                        <p class="flex items-start">
                            <i class="fas fa-sync-alt text-purple-500 mr-2 mt-1"></i>
                            <span>If promoted, you can update your bid in Round 2</span>
                        </p>
                        <p class="flex items-start">
                            <i class="fas fa-times-circle text-red-500 mr-2 mt-1"></i>
                            <span>If not promoted, your bid will be marked as "not selected"</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Your Proposal Preview -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h3 class="font-semibold text-gray-900 mb-3">Your Proposal</h3>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <p class="text-gray-700 line-clamp-4"><%= bid.proposal %></p>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            <%= bid.proposal.length %> characters
                        </span>
                        <a href="/seller/bid-details/<%= bid.project._id %>" 
                           class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                            View Full Details
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Updates Notice -->
        <div class="mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center">
                <i class="fas fa-sync-alt text-green-500 mr-3"></i>
                <div>
                    <p class="text-sm text-green-700">
                        <strong>Real-time Updates:</strong> This page will automatically refresh to show any status changes. 
                        You'll also receive notifications if you're promoted from the waiting queue.
                    </p>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Waiting queue page loaded');
    
    // Auto-refresh for status updates
    setInterval(() => {
        console.log('Auto-refreshing waiting queue status...');
        location.reload();
    }, 30000); // Refresh every 30 seconds

    // Add visual feedback for queue position
    const queuePosition = parseInt(document.querySelector('[class*="bg-blue-100"]')?.textContent?.match(/\d+/)?.[0] || '0');
    const positionElement = document.querySelector('[class*="bg-blue-100"]');
    
    if (positionElement && queuePosition <= 3) {
        positionElement.classList.remove('bg-blue-100', 'text-blue-800');
        positionElement.classList.add('bg-green-100', 'text-green-800');
    }

    // Optional: Add countdown timer for customer review period
    function updateReviewCountdown() {
        // This would typically use the actual project review deadline
        const reviewEndTime = new Date(Date.now() + (24 * 60 * 60 * 1000)); // Example: 24 hours from now
        const now = new Date();
        const timeLeft = reviewEndTime - now;
        
        if (timeLeft <= 0) {
            console.log('Review period ended');
            return;
        }
        
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        // You could display this countdown if you add an element for it
        const countdownElement = document.getElementById('review-countdown');
        if (countdownElement) {
            countdownElement.textContent = `${hours}h ${minutes}m remaining`;
        }
    }

    // Update countdown every minute
    updateReviewCountdown();
    setInterval(updateReviewCountdown, 60000);
});
</script>

    <%- include('../partials/footer') %>
</body>
</html>