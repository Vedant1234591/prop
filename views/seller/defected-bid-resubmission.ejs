<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resubmit Defected Bid - Propload</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <%- include('../partials/header', { 
        user: user, 
        currentPage: 'my-bids',
        bidCount: bidCount || 0
    }) %>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <%- include('../partials/flash-messages') %>

        <!-- Header -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Resubmit Defected Bid</h1>
                    <p class="text-gray-600 mt-2">Your bid has been marked as defected. Please review the customer's remarks and resubmit within 24 hours.</p>
                </div>
                <span class="px-4 py-2 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                    DEFECTED - RESUBMISSION REQUIRED
                </span>
            </div>
            
            <!-- Critical Time Information -->
            <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3 mt-1"></i>
                        <div>
                            <h3 class="font-semibold text-red-800">24-Hour Resubmission Deadline</h3>
                            <p class="text-red-700 mt-1">
                                You have <strong id="time-remaining"><%= moment(bid.resubmissionDeadline).fromNow(true) %></strong> to resubmit your bid.
                                If you don't resubmit in time, you will be automatically moved to <strong>Lost</strong> and replaced by the next bidder in waiting queue.
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-red-600">
                            <i class="fas fa-clock mr-1"></i>
                            Deadline: <%= moment(bid.resubmissionDeadline).format('MMM D, h:mm A') %>
                        </p>
                        <p class="text-xs text-red-500 mt-1" id="countdown-timer">
                            <%= moment(bid.resubmissionDeadline).fromNow() %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Defect Information -->
            <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start">
                    <i class="fas fa-comment-alt text-yellow-500 text-xl mr-3 mt-1"></i>
                    <div class="flex-1">
                        <h3 class="font-semibold text-yellow-800 mb-2">Defect Remarks from Customer</h3>
                        <div class="bg-white border border-yellow-300 rounded-md p-3">
                            <p class="text-yellow-700 whitespace-pre-wrap"><%= bid.agreementResponses.adminRemarks %></p>
                        </div>
                        <div class="mt-3 grid md:grid-cols-2 gap-4 text-sm text-yellow-700">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span>Defect Count: <strong><%= bid.agreementResponses.defectCount %> of <%= bid.agreementResponses.maxDefectCount %> maximum</strong></span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-sync-alt mr-2"></i>
                                <span>Resubmission Attempt: <strong><%= bid.agreementResponses.defectCount %> of 3</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Process Flow Info -->
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-semibold text-blue-800 mb-2">What Happens After Resubmission?</h4>
                <div class="grid md:grid-cols-2 gap-4 text-sm text-blue-700">
                    <div class="flex items-start">
                        <span class="bg-blue-100 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-2 mt-0.5">1</span>
                        <span><strong>Resubmit:</strong> Your bid goes back to Round 1 Selected section</span>
                    </div>
                    <div class="flex items-start">
                        <span class="bg-green-100 text-green-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-2 mt-0.5">2</span>
                        <span><strong>Customer Review:</strong> Customer reviews your updated bid</span>
                    </div>
                    <div class="flex items-start">
                        <span class="bg-purple-100 text-purple-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-2 mt-0.5">3</span>
                        <span><strong>Selection:</strong> Customer can select for Round 2 or mark defect again</span>
                    </div>
                    <div class="flex items-start">
                        <span class="bg-red-100 text-red-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-2 mt-0.5">4</span>
                        <span><strong>Time Out:</strong> If no resubmission in 24h, you lose your spot to waiting queue</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Information -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Project Information</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900"><%= bid.project.title %></h3>
                    <p class="text-gray-600 mt-2"><%= bid.project.description %></p>
                </div>
                <div class="text-sm text-gray-600 space-y-2">
                    <div class="flex justify-between">
                        <span>Category:</span>
                        <span class="font-medium capitalize"><%= bid.project.category.replace('-', ' ') %></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Location:</span>
                        <span class="font-medium"><%= bid.project.location.city %>, <%= bid.project.location.state %></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Your Original Bid:</span>
                        <span class="font-bold text-green-600">$<%= bid.amount.toLocaleString() %></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Current Position:</span>
                        <span class="font-medium text-orange-600">Defected - Needs Resubmission</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resubmission Form -->
        <form action="/seller/bid/<%= bid._id %>/resubmit-defected" method="POST" class="space-y-6">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">

            <!-- Updated Bid Details -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Update Your Bid</h2>
                
                <!-- Bid Amount -->
                <div class="mb-6">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                        Updated Bid Amount ($) *
                        <span class="text-green-600 ml-2">You can adjust your bid amount</span>
                    </label>
                    <input type="number" 
                           id="amount" 
                           name="amount" 
                           required 
                           min="<%= bid.project.bidSettings.startingBid %>" 
                           step="0.01"
                           value="<%= bid.amount %>"
                           class="w-full border border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg font-semibold">
                    <p class="text-sm text-gray-500 mt-1">
                        Minimum bid: $<%= bid.project.bidSettings.startingBid %> • 
                        <span class="text-blue-600">Original: $<%= bid.amount.toLocaleString() %></span>
                    </p>
                </div>

                <!-- Updated Proposal -->
                <div>
                    <label for="proposal" class="block text-sm font-medium text-gray-700 mb-2">
                        Updated Proposal *
                        <span class="text-red-600 ml-2">Must address customer's defect remarks</span>
                    </label>
                    <textarea id="proposal" 
                              name="proposal" 
                              rows="6" 
                              required
                              class="w-full border border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="Update your proposal addressing the customer's defect remarks specifically..."><%= bid.proposal %></textarea>
                    <p class="text-sm text-gray-500 mt-1">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>
                        Make sure to directly address the customer's concerns mentioned in the defect remarks above.
                    </p>
                </div>
            </div>

            <!-- Updated Agreement Responses -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Review and Update Agreement Responses</h2>
                <p class="text-gray-600 mb-6 text-sm">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    <strong>Important:</strong> Pay special attention to the clauses that caused the defect. 
                    You must either agree with required clauses or provide compelling reasons for disagreement.
                </p>

                <div class="space-y-6">
                    <% agreements.clauses.forEach((clause, index) => { %>
                        <% 
                        let originalResponse = null;
                        if (clause && clause._id && bid.agreementResponses && bid.agreementResponses.responses) {
                            originalResponse = bid.agreementResponses.responses.find(r => 
                                r && r.clauseId && clause._id && r.clauseId.toString() === clause._id.toString()
                            );
                        }
                        %>
                        <div class="border border-gray-200 rounded-lg p-4 <%= clause.required ? 'bg-blue-50 border-blue-200' : '' %>" 
                             data-required="<%= clause.required %>" 
                             data-clause-id="<%= clause._id %>">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-900 flex items-center">
                                        <%= clause.clauseNumber %>. <%= clause.title %>
                                        <% if (clause.required) { %>
                                        <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Required</span>
                                        <% } %>
                                    </h3>
                                    <p class="text-gray-600 mt-2 text-sm"><%= clause.description %></p>
                                    
                                    <!-- Original Response -->
                                    <% if (originalResponse) { %>
                                    <div class="mt-2 p-2 bg-gray-50 rounded-md">
                                        <p class="text-xs text-gray-600">
                                            <strong>Your Original Response:</strong> 
                                            <span class="<%= originalResponse.agreed ? 'text-green-600' : 'text-red-600' %>">
                                                <%= originalResponse.agreed ? 'AGREED' : 'DISAGREED' %>
                                            </span>
                                            <% if (!originalResponse.agreed && originalResponse.remarks) { %>
                                                - <em>"<%= originalResponse.remarks %>"</em>
                                            <% } %>
                                        </p>
                                    </div>
                                    <% } %>
                                </div>
                            </div>

                            <!-- Updated Agreement Options -->
                            <div class="mt-4 space-y-3">
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" 
                                               name="agreementResponses[<%= clause._id %>][agreed]" 
                                               value="true" 
                                               required
                                               <%= originalResponse && originalResponse.agreed ? 'checked' : '' %>
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                        <span class="ml-2 text-sm text-gray-700">I Agree</span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input type="radio" 
                                               name="agreementResponses[<%= clause._id %>][agreed]" 
                                               value="false"
                                               <%= originalResponse && !originalResponse.agreed ? 'checked' : '' %>
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                        <span class="ml-2 text-sm text-gray-700">I Do Not Agree</span>
                                    </label>
                                </div>

                                <!-- Remarks Field -->
                                <div id="remarks-<%= clause._id %>" class="<%= originalResponse && !originalResponse.agreed ? '' : 'hidden' %>">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Remarks <% if (clause.required) { %>(Required if not agreeing)<% } %>
                                        <span class="text-red-600 text-xs ml-2">Customer will carefully review this</span>
                                    </label>
                                    <textarea name="agreementResponses[<%= clause._id %>][remarks]" 
                                              rows="3"
                                              class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                              placeholder="Explain your position on this clause. Be detailed and convincing..."><%= originalResponse && originalResponse.remarks ? originalResponse.remarks : '' %></textarea>
                                    <% if (clause.required) { %>
                                    <p class="text-xs text-red-600 mt-1">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        Remarks are required when you disagree with a required clause. Customer may mark as defected again if not satisfied.
                                    </p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>

                <!-- Resubmission Guidelines -->
                <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-800 mb-2">Resubmission Guidelines</h4>
                    <ul class="text-sm text-yellow-700 space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mr-2 mt-1 text-green-500"></i>
                            <span><strong>Address all concerns</strong> mentioned in the customer's defect remarks</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-comment-alt mr-2 mt-1 text-blue-500"></i>
                            <span><strong>Provide detailed explanations</strong> for any disagreements with required clauses</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-clock mr-2 mt-1 text-red-500"></i>
                            <span><strong>Resubmit within 24 hours</strong> or you will lose your spot to the waiting queue</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-sync-alt mr-2 mt-1 text-purple-500"></i>
                            <span>You have <strong><%= bid.agreementResponses.maxDefectCount - bid.agreementResponses.defectCount %> resubmission attempts remaining</strong> out of 3 maximum</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Ready to Resubmit</h3>
                        <p class="text-gray-600 text-sm">
                            After resubmission, your bid will go back to Round 1 Selected for customer review.
                            Customer can either select you for Round 2 or mark as defected again.
                        </p>
                    </div>
                    <div class="space-x-4">
                        <a href="/seller/my-bids" 
                           class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition duration-300">
                            Cancel
                        </a>
                        <button type="submit" 
                                id="submitBtn"
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 font-semibold">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Resubmit Bid
                        </button>
                    </div>
                </div>
                
                <!-- Consequences of Not Resubmitting -->
                <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                    <h4 class="font-semibold text-red-800 mb-2">⚠️ What Happens If You Don't Resubmit in Time?</h4>
                    <div class="grid md:grid-cols-2 gap-4 text-sm text-red-700">
                        <div class="flex items-center">
                            <i class="fas fa-times-circle mr-2"></i>
                            <span>Your bid moves to <strong>Lost</strong> section automatically</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-user-plus mr-2"></i>
                            <span>Next bidder in waiting queue takes your spot</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-door-open mr-2"></i>
                            <span>You lose opportunity to proceed to Round 2</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-history mr-2"></i>
                            <span>Defect count increases for future reference</span>
                        </div>
                    </div>
                </div>

                <!-- Validation Summary -->
                <div id="validation-summary" class="mt-4 hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <h4 class="font-semibold text-red-800 mb-2">Please fix the following issues:</h4>
                    <ul id="validation-errors" class="text-sm text-red-700 space-y-1"></ul>
                </div>
            </div>
        </form>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    const countdownTimer = document.getElementById('countdown-timer');
    const timeRemaining = document.getElementById('time-remaining');

    // Real-time countdown for resubmission deadline
    function updateResubmissionCountdown() {
        const deadline = new Date('<%= bid.resubmissionDeadline %>');
        const now = new Date();
        const timeLeft = deadline - now;
        
        if (timeLeft <= 0) {
            // Deadline passed
            form.style.opacity = '0.6';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-clock mr-2"></i>Resubmission Deadline Passed';
            countdownTimer.textContent = 'Time expired - Bid moved to Lost';
            countdownTimer.classList.add('text-red-600', 'font-bold');
            timeRemaining.textContent = '0 hours';
            return;
        }
        
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        countdownTimer.textContent = `${hours}h ${minutes}m ${seconds}s`;
        timeRemaining.textContent = `${hours} hours ${minutes} minutes`;
        
        // Warning when less than 2 hours remaining
        if (hours < 2) {
            countdownTimer.classList.add('text-red-600', 'font-bold');
            timeRemaining.classList.add('text-red-600', 'font-bold');
        }
    }

    // Update countdown every second
    updateResubmissionCountdown();
    setInterval(updateResubmissionCountdown, 1000);

    // Toggle remarks field based on agreement selection
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const clauseId = this.name.match(/\[(.*?)\]/)[1];
            const remarksDiv = document.getElementById(`remarks-${clauseId}`);
            const isDisagree = this.value === 'false' && this.checked;
            
            if (remarksDiv) {
                remarksDiv.classList.toggle('hidden', !isDisagree);
                const textarea = remarksDiv.querySelector('textarea');
                if (isDisagree && textarea) {
                    textarea.required = true;
                } else if (textarea) {
                    textarea.required = false;
                }
            }
        });
    });

    // Form validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const errors = [];
        const form = this;
        
        // Validate bid amount
        const amount = parseFloat(form.amount.value);
        const minAmount = parseFloat(form.amount.min);
        if (!amount || amount < minAmount) {
            errors.push(`Bid amount must be at least $${minAmount}`);
        }
        
        // Validate proposal addresses defect remarks
        if (!form.proposal.value.trim() || form.proposal.value.trim().length < 100) {
            errors.push('Proposal must be at least 100 characters long and address the defect remarks');
        }
        
        // Check if proposal mentions defect concerns (basic check)
        const defectRemarks = '<%= bid.agreementResponses.adminRemarks %>'.toLowerCase();
        const proposalText = form.proposal.value.toLowerCase();
        if (!defectRemarks.split(' ').some(word => word.length > 3 && proposalText.includes(word))) {
            errors.push('Your proposal should specifically address the customer\'s defect remarks');
        }
        
        // Validate required agreements
        const requiredClauseElements = document.querySelectorAll('[data-required="true"]');
        requiredClauseElements.forEach(clauseElement => {
            const clauseId = clauseElement.dataset.clauseId;
            const agreementInput = form.querySelector(`input[name="agreementResponses[${clauseId}][agreed]"]:checked`);
            if (!agreementInput) {
                errors.push(`All required agreements must be accepted or rejected`);
            } else if (agreementInput.value === 'false') {
                const remarks = form.querySelector(`textarea[name="agreementResponses[${clauseId}][remarks]"]`);
                if (!remarks || !remarks.value.trim()) {
                    errors.push(`Detailed remarks are required for required clauses that you disagree with`);
                }
            }
        });

        // Check if resubmission deadline has passed
        const deadline = new Date('<%= bid.resubmissionDeadline %>');
        if (new Date() > deadline) {
            errors.push('Resubmission deadline has passed. Your bid has been automatically moved to Lost.');
        }
        
        // Show errors or submit form
        const validationSummary = document.getElementById('validation-summary');
        const validationErrors = document.getElementById('validation-errors');
        
        if (errors.length > 0) {
            validationErrors.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
            validationSummary.classList.remove('hidden');
            validationSummary.scrollIntoView({ behavior: 'smooth' });
        } else {
            validationSummary.classList.add('hidden');
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Resubmitting...';
            submitBtn.disabled = true;
            
            // Submit form
            form.submit();
        }
    });
  
    // Initialize remarks fields based on current selections
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const clauseId = radio.name.match(/\[(.*?)\]/)[1];
        const remarksDiv = document.getElementById(`remarks-${clauseId}`);
        if (radio.value === 'false' && remarksDiv) {
            remarksDiv.classList.remove('hidden');
        }
    });

    // Auto-refresh for real-time status updates (more frequent as deadline approaches)
    setInterval(() => {
        const deadline = new Date('<%= bid.resubmissionDeadline %>');
        const timeLeft = deadline - new Date();
        
        // Refresh more frequently when less than 1 hour remaining
        if (timeLeft > 0 && timeLeft < 60 * 60 * 1000) {
            console.log('Auto-refreshing for resubmission deadline...');
            location.reload();
        }
    }, 30000); // Check every 30 seconds
});
</script>

    <%- include('../partials/footer') %>
</body>
</html>