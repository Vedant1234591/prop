<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round 1 Bid - Propload</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <%- include('../partials/header', { 
        user: user, 
        currentPage: 'find-bids',
        bidCount: bidCount || 0
    }) %>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <%- include('../partials/flash-messages') %>

        <!-- Project Header -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900"><%= project.title %></h1>
                    <p class="text-gray-600 mt-2"><%= project.description %></p>
                </div>
                <span class="px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    ROUND 1 BIDDING
                </span>
            </div>
            
            <!-- Bidding Process Info -->
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-2">Bidding Process Overview</h3>
                <div class="grid md:grid-cols-2 gap-4 text-sm text-blue-700">
                    <div class="flex items-start">
                        <i class="fas fa-robot mr-2 mt-1"></i>
                        <span><strong>Auto-selection:</strong> Top 3 lowest bids automatically advance to Round 1 Selected</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-users mr-2 mt-1"></i>
                        <span><strong>Waiting Queue:</strong> Next 7 bids (positions 4-10) wait for defect replacements</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle mr-2 mt-1"></i>
                        <span><strong>Defect System:</strong> Customer can mark bids as defected with remarks</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-clock mr-2 mt-1"></i>
                        <span><strong>24h Resubmission:</strong> Defected bids have 24 hours to resubmit</span>
                    </div>
                </div>
            </div>

            <div class="mt-4 grid md:grid-cols-3 gap-4 text-sm text-gray-600">
                <div class="flex items-center">
                    <i class="fas fa-tag mr-2 text-indigo-500"></i>
                    <span class="capitalize"><%= project.category.replace('-', ' ') %></span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
                    <span><%= project.location.city %>, <%= project.location.state %></span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-clock mr-2 text-orange-500"></i>
                    <span>Ends: <%= moment(project.biddingRounds.round1.endDate).format('MMM D, h:mm A') %></span>
                </div>
            </div>
        </div>

        <!-- Bid Form -->
        <form action="/seller/project/<%= project._id %>/submit-round1-bid" method="POST" class="space-y-6">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">

            <!-- Bid Details Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Bid Details</h2>
                
                <!-- Bid Amount - Emphasizing Lowest Bid Strategy -->
                <div class="mb-6">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                        Bid Amount ($) *
                        <span class="text-green-600 ml-2">← Lower bids have better chance of selection</span>
                    </label>
                    <input type="number" 
                           id="amount" 
                           name="amount" 
                           required 
                           min="<%= project.bidSettings.startingBid %>" 
                           step="0.01"
                           value="<%= existingBid ? existingBid.amount : project.bidSettings.startingBid %>"
                           class="w-full border border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg font-semibold"
                           placeholder="Enter your bid amount">
                    <p class="text-sm text-gray-500 mt-1">
                        Minimum bid: $<%= project.bidSettings.startingBid %> • 
                        <span class="text-green-600 font-medium">Top 3 lowest bids advance automatically</span>
                    </p>
                </div>

                <!-- Proposal -->
                <div>
                    <label for="proposal" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Proposal *
                    </label>
                    <textarea id="proposal" 
                              name="proposal" 
                              rows="6" 
                              required
                              class="w-full border border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="Describe your approach, methodology, timeline, and why you're the best fit for this project..."><%= existingBid ? existingBid.proposal : '' %></textarea>
                    <p class="text-sm text-gray-500 mt-1">Minimum 100 characters. Be specific about how you'll deliver this project.</p>
                </div>
            </div>

            <!-- Agreements Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Project Agreements</h2>
                <p class="text-gray-600 mb-6">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    <strong>Important:</strong> If you disagree with any required clause, you must provide detailed remarks. 
                    Customer may mark your bid as defected if they don't accept your disagreement.
                </p>

                <div class="space-y-6">
                    <% agreements.clauses.forEach((clause, index) => { %>
                    <div class="border border-gray-200 rounded-lg p-4 <%= clause.required ? 'bg-blue-50 border-blue-200' : '' %>"
                         data-required="<%= clause.required %>" 
                         data-clause-id="<%= clause._id %>">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 flex items-center">
                                    <%= clause.clauseNumber %>. <%= clause.title %>
                                    <% if (clause.required) { %>
                                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Required</span>
                                    <% } %>
                                </h3>
                                <p class="text-gray-600 mt-2 text-sm"><%= clause.description %></p>
                            </div>
                        </div>

                        <!-- Agreement Options -->
                        <div class="mt-4 space-y-3">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" 
                                           name="agreementResponses[<%= clause._id %>][agreed]" 
                                           value="true" 
                                           required
                                           <%= (existingBid && existingBid.agreementResponses.responses.find(r => r.clauseId.toString() === clause._id.toString())?.agreed) ? 'checked' : '' %>
                                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                    <span class="ml-2 text-sm text-gray-700">I Agree</span>
                                </label>
                                
                                <label class="flex items-center">
                                    <input type="radio" 
                                           name="agreementResponses[<%= clause._id %>][agreed]" 
                                           value="false"
                                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                    <span class="ml-2 text-sm text-gray-700">I Do Not Agree</span>
                                </label>
                            </div>

                            <!-- Remarks Field (Required if not agreeing) -->
                            <div id="remarks-<%= clause._id %>" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Remarks (Required) *
                                    <span class="text-red-600 text-xs ml-2">Customer will review these remarks</span>
                                </label>
                                <textarea name="agreementResponses[<%= clause._id %>][remarks]" 
                                          rows="3"
                                          class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                          placeholder="Please explain why you do not agree with this clause. Customer may mark your bid as defected if they don't accept your reasoning..."></textarea>
                                <p class="text-xs text-red-600 mt-1">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    Remarks are required when you disagree. Customer may mark as defected and you'll have 24 hours to resubmit.
                                </p>
                            </div>
                        </div>
                    </div>
                    <% }) %>
                </div>

                <!-- Agreement Summary -->
                <div class="mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-2">Agreement Summary</h4>
                    <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
                        <div>
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span id="agreed-count">0</span> clauses agreed
                        </div>
                        <div>
                            <i class="fas fa-times-circle text-red-500 mr-2"></i>
                            <span id="disagreed-count">0</span> clauses disagreed
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        All required agreements must be accepted to submit your bid. If you disagree with any required clause, 
                        you must provide detailed remarks. Customer may mark your bid as defected during review.
                    </p>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Ready to Submit</h3>
                        <p class="text-gray-600 text-sm">
                            After submission, your bid will be automatically ranked with others. Top 3 lowest bids advance to customer review.
                        </p>
                    </div>
                    <div class="space-x-4">
                        <a href="/seller/bid-details/<%= project._id %>" 
                           class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition duration-300">
                            Cancel
                        </a>
                        <button type="submit" 
                                id="submitBtn"
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 font-semibold">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Submit Round 1 Bid
                        </button>
                    </div>
                </div>
                
                <!-- Process Flow Info -->
                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">What Happens Next?</h4>
                    <div class="grid md:grid-cols-3 gap-4 text-sm text-blue-700">
                        <div class="flex items-start">
                            <span class="bg-blue-100 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-2 mt-0.5">1</span>
                            <span><strong>Auto-ranking:</strong> All bids ranked by amount after round ends</span>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-orange-100 text-orange-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-2 mt-0.5">2</span>
                            <span><strong>Top 3 Selected:</strong> Lowest 3 bids go to customer for review</span>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-purple-100 text-purple-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-2 mt-0.5">3</span>
                            <span><strong>Customer Review:</strong> Customer can mark bids as defected with remarks</span>
                        </div>
                    </div>
                </div>

                <!-- Validation Summary -->
                <div id="validation-summary" class="mt-4 hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <h4 class="font-semibold text-red-800 mb-2">Please fix the following issues:</h4>
                    <ul id="validation-errors" class="text-sm text-red-700 space-y-1"></ul>
                </div>
            </div>
        </form>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle remarks field based on agreement selection
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const clauseId = this.name.match(/\[(.*?)\]/)[1];
            const remarksDiv = document.getElementById(`remarks-${clauseId}`);
            const isDisagree = this.value === 'false' && this.checked;
            
            if (remarksDiv) {
                remarksDiv.classList.toggle('hidden', !isDisagree);
                if (isDisagree) {
                    remarksDiv.querySelector('textarea').required = true;
                } else {
                    remarksDiv.querySelector('textarea').required = false;
                }
            }
            updateAgreementSummary();
        });
    });

    // Update agreement summary
    function updateAgreementSummary() {
        let agreedCount = 0;
        let disagreedCount = 0;
        
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            if (radio.value === 'true') agreedCount++;
            if (radio.value === 'false') disagreedCount++;
        });
        
        document.getElementById('agreed-count').textContent = agreedCount;
        document.getElementById('disagreed-count').textContent = disagreedCount;
    }

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const errors = [];
        const form = this;
        
        // Validate bid amount
        const amount = parseFloat(form.amount.value);
        const minAmount = parseFloat(form.amount.min);
        if (!amount || amount < minAmount) {
            errors.push(`Bid amount must be at least $${minAmount}`);
        }
        
        // Validate proposal
        if (!form.proposal.value.trim() || form.proposal.value.trim().length < 100) {
            errors.push('Proposal must be at least 100 characters long');
        }
        
        // Validate required agreements
        const requiredClauseElements = document.querySelectorAll('[data-required="true"]');
        requiredClauseElements.forEach(clauseElement => {
            const clauseId = clauseElement.dataset.clauseId;
            const clauseTitle = clauseElement.querySelector('h3').textContent;
            const agreementInput = form.querySelector(`input[name="agreementResponses[${clauseId}][agreed]"]:checked`);
            
            if (!agreementInput) {
                errors.push(`Required agreement "${clauseTitle}" must be accepted or rejected`);
            } else if (agreementInput.value === 'false') {
                const remarks = form.querySelector(`textarea[name="agreementResponses[${clauseId}][remarks]"]`);
                if (!remarks || !remarks.value.trim()) {
                    errors.push(`Remarks are required for "${clauseTitle}" since you disagree`);
                }
            }
        });
        
        // Show errors or submit form
        const validationSummary = document.getElementById('validation-summary');
        const validationErrors = document.getElementById('validation-errors');
        
        if (errors.length > 0) {
            validationErrors.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
            validationSummary.classList.remove('hidden');
            validationSummary.scrollIntoView({ behavior: 'smooth' });
        } else {
            validationSummary.classList.add('hidden');
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting Bid...';
            submitBtn.disabled = true;
            
            // Submit form
            form.submit();
        }
    });

    // Initialize agreement summary
    updateAgreementSummary();

    // Auto-refresh for real-time status updates
    setInterval(() => {
        const hasActiveItems = document.querySelectorAll('[data-needs-refresh="true"]').length > 0;
        if (hasActiveItems) {
            console.log('Auto-refreshing for status updates...');
            location.reload();
        }
    }, 30000);
});
</script>

    <%- include('../partials/footer') %>
</body>
</html>