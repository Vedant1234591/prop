<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round 2 Selection - Propload</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <%- include('../partials/header') %>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <%- include('../partials/flash-messages') %>

        <!-- Header -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Round 2: Select Winning Bid</h1>
                    <p class="text-gray-600 mt-2">Project: <strong><%= project.title %></strong></p>
                    <p class="text-gray-500 text-sm mt-1">Select the final winning bid from the top 3</p>
                    <p class="text-yellow-600 text-sm mt-1">
                        <i class="fas fa-clock mr-1"></i>
                        Final selection - Contract process will begin immediately
                    </p>
                </div>
                <div class="text-right">
                    <span class="px-4 py-2 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                        Final Selection
                    </span>
                    <p class="text-sm text-gray-500 mt-2">
                        Bids Available: <span class="font-semibold"><%= bids.length %></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Selection Instructions -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
            <div class="flex items-start">
                <i class="fas fa-trophy text-purple-600 text-xl mt-1 mr-3"></i>
                <div>
                    <h3 class="text-lg font-semibold text-purple-800 mb-2">Final Selection Process</h3>
                    <ul class="text-purple-700 space-y-2">
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            Review the top 3 bids from Round 2 (updated proposals)
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            Select one winning bid - consider both price and proposal quality
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            Contract process will begin automatically with the winner
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            Other bids will be marked as lost
                        </li>
                        <li class="flex items-center text-green-600 font-medium">
                            <i class="fas fa-file-contract mr-2"></i>
                            After selection, you'll need to download, sign, and upload the contract
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Bids Comparison -->
        <form id="selection-form" action="/customer/project/<%= project._id %>/select-winner" method="POST">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            
            <div class="grid gap-6">
                <% bids.forEach((bid, index) => { %>
                <div class="bid-option bg-white shadow rounded-lg p-6 border-2 border-gray-200 transition-all duration-300 hover:shadow-lg cursor-pointer"
                     onclick="selectBid('<%= bid._id %>')"
                     data-bid-id="<%= bid._id %>">
                    <div class="flex justify-between items-start">
                        <!-- Bid Information -->
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                                            Option #<%= index + 1 %>
                                        </span>
                                        <span class="text-3xl font-bold text-green-600">$<%= bid.amount.toLocaleString() %></span>
                                        <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs">
                                            <i class="fas fa-gavel mr-1"></i>Round 2
                                        </span>
                                        <% if (bid.revisions && bid.revisions.length > 1) { %>
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                            <i class="fas fa-edit mr-1"></i>Revised
                                        </span>
                                        <% } %>
                                    </div>
                                    
                                    <!-- Seller Information -->
                                    <div class="flex items-center space-x-4 mb-4">
                                        <% if (bid.seller.profileImage && bid.seller.profileImage.url) { %>
                                        <img src="<%= bid.seller.profileImage.url %>" 
                                             alt="<%= bid.seller.companyName || bid.seller.name %>"
                                             class="w-20 h-20 rounded-full object-cover border-2 border-gray-200">
                                        <% } else { %>
                                        <div class="w-20 h-20 bg-gray-300 rounded-full flex items-center justify-center border-2 border-gray-200">
                                            <i class="fas fa-user text-gray-600 text-2xl"></i>
                                        </div>
                                        <% } %>
                                        
                                        <div class="flex-1">
                                            <h3 class="text-2xl font-semibold text-gray-900 mb-1">
                                                <%= bid.seller.companyName || bid.seller.name %>
                                            </h3>
                                            <p class="text-gray-600 text-lg mb-1"><%= bid.seller.email %></p>
                                            <% if (bid.seller.phone) { %>
                                            <p class="text-gray-500"><%= bid.seller.phone %></p>
                                            <% } %>
                                        </div>
                                    </div>

                                    <!-- Rating and Experience -->
                                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                                        <% if (bid.seller.ratings && bid.seller.ratings.average > 0) { %>
                                        <div class="bg-yellow-50 rounded-lg p-3 text-center">
                                            <div class="text-yellow-800 font-semibold mb-1">Rating</div>
                                            <div class="flex items-center justify-center">
                                                <% for (let i = 1; i <= 5; i++) { %>
                                                <i class="fas fa-star <%= i <= Math.floor(bid.seller.ratings.average) ? 'text-yellow-400' : 'text-gray-300' %> mr-1"></i>
                                                <% } %>
                                                <span class="text-lg font-bold text-gray-800 ml-2">
                                                    <%= bid.seller.ratings.average.toFixed(1) %>
                                                </span>
                                            </div>
                                            <div class="text-gray-600 text-sm mt-1">
                                                <%= bid.seller.ratings.count %> reviews
                                            </div>
                                        </div>
                                        <% } %>

                                        <% if (bid.seller.yearsOfExperience) { %>
                                        <div class="bg-blue-50 rounded-lg p-3 text-center">
                                            <div class="text-blue-800 font-semibold mb-1">Experience</div>
                                            <div class="text-2xl font-bold text-gray-800">
                                                <%= bid.seller.yearsOfExperience %>
                                            </div>
                                            <div class="text-gray-600 text-sm">years</div>
                                        </div>
                                        <% } %>

                                        <div class="bg-green-50 rounded-lg p-3 text-center">
                                            <div class="text-green-800 font-semibold mb-1">Bid Amount</div>
                                            <div class="text-2xl font-bold text-gray-800">
                                                $<%= bid.amount.toLocaleString() %>
                                            </div>
                                            <div class="text-gray-600 text-sm">final offer</div>
                                        </div>
                                    </div>

                                    <!-- Updated Proposal -->
                                    <div class="mb-4">
                                        <h4 class="font-semibold text-gray-700 mb-2 text-lg">Final Proposal:</h4>
                                        <p class="text-gray-600 bg-gray-50 rounded-lg p-4 text-lg leading-relaxed">
                                            <%= bid.proposal %>
                                        </p>
                                    </div>

                                    <!-- Specializations -->
                                    <% if (bid.seller.specialization && bid.seller.specialization.length > 0) { %>
                                    <div class="mb-4">
                                        <h4 class="font-semibold text-gray-700 mb-2">Areas of Expertise:</h4>
                                        <div class="flex flex-wrap gap-2">
                                            <% bid.seller.specialization.forEach(spec => { %>
                                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                                                <%= spec %>
                                            </span>
                                            <% }) %>
                                        </div>
                                    </div>
                                    <% } %>

                                    <!-- Company Documents -->
                                    <% if (bid.seller.companyDocuments && bid.seller.companyDocuments.length > 0) { %>
                                    <div class="border-t border-gray-200 pt-4">
                                        <h4 class="font-semibold text-gray-700 mb-2">Verified Documents:</h4>
                                        <div class="grid grid-cols-2 gap-2">
                                            <% bid.seller.companyDocuments.forEach(doc => { %>
                                            <a href="<%= doc.url %>" 
                                               target="_blank"
                                               class="flex items-center px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-300">
                                                <i class="fas <%= doc.documentType === 'license' ? 'fa-id-card' : doc.documentType === 'certificate' ? 'fa-award' : doc.documentType === 'insurance' ? 'fa-shield-alt' : 'fa-file' %> mr-2 text-blue-500"></i>
                                                <span class="flex-1"><%= doc.documentType || 'Document' %></span>
                                                <i class="fas fa-external-link-alt text-gray-400"></i>
                                            </a>
                                            <% }) %>
                                        </div>
                                    </div>
                                    <% } %>
                                </div>

                                <!-- Selection Radio -->
                                <div class="ml-6">
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" 
                                               name="winningBidId" 
                                               value="<%= bid._id %>"
                                               id="bid-<%= bid._id %>"
                                               class="winning-bid-radio h-6 w-6 text-green-600 border-gray-300 focus:ring-green-500 transition duration-300">
                                        <label for="bid-<%= bid._id %>" class="text-lg font-semibold text-gray-700 cursor-pointer">
                                            Select as Winner
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>

            <!-- Submit Button -->
            <div class="mt-8 text-center">
                <button type="submit" 
                        id="submit-btn"
                        disabled
                        class="bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 transition duration-300 font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center mx-auto">
                    <i class="fas fa-trophy mr-3"></i>
                    Confirm Winning Bid & Start Contract Process
                </button>
                <p id="selection-hint" class="text-gray-500 mt-2">
                    Please select one bid as the winner
                </p>
            </div>
        </form>

        <!-- No Bids Message -->
        <% if (bids.length === 0) { %>
        <div class="bg-white shadow rounded-lg p-12 text-center">
            <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Bids Available</h3>
            <p class="text-gray-500">There are no bids to display for final selection.</p>
        </div>
        <% } %>
    </div>

    <script>
        let selectedBid = null;

        function selectBid(bidId) {
            // Update radio button
            const radio = document.getElementById(`bid-${bidId}`);
            radio.checked = true;
            
            // Remove previous selection styles
            document.querySelectorAll('.bid-option').forEach(option => {
                option.classList.remove('border-green-500', 'bg-green-50', 'ring-2', 'ring-green-500');
            });
            
            // Add selection style to current bid
            const selectedOption = document.querySelector(`[data-bid-id="${bidId}"]`);
            selectedOption.classList.add('border-green-500', 'bg-green-50', 'ring-2', 'ring-green-500');
            
            selectedBid = bidId;
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            const selectionHint = document.getElementById('selection-hint');
            
            if (selectedBid) {
                submitBtn.disabled = false;
                selectionHint.textContent = 'Ready to confirm the winning bid and start contract process';
                selectionHint.className = 'text-green-600 mt-2 font-medium';
            } else {
                submitBtn.disabled = true;
                selectionHint.textContent = 'Please select one bid as the winner';
                selectionHint.className = 'text-gray-500 mt-2';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers to radio buttons
            document.querySelectorAll('.winning-bid-radio').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        selectBid(this.value);
                    }
                });
            });

            // Form submission confirmation
            document.getElementById('selection-form').addEventListener('submit', function(e) {
                if (!selectedBid) {
                    e.preventDefault();
                    showAlert('Please select a winning bid before proceeding', 'error');
                    return;
                }
                
                const confirmed = confirm('Are you sure you want to select this bid as the winner? This action cannot be undone and the contract process will begin immediately.');
                if (!confirmed) {
                    e.preventDefault();
                }
            });

            function showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                    type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
                }`;
                alertDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            }

            // Add hover effects
            const bidOptions = document.querySelectorAll('.bid-option');
            bidOptions.forEach(option => {
                option.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('border-green-500')) {
                        this.classList.add('border-gray-300');
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('border-green-500')) {
                        this.classList.remove('border-gray-300');
                    }
                });
            });
        });
    </script>

    <%- include('../partials/footer') %>
</body>
</html>