<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Winner - Propload</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <%- include('./sideNav') %>

    <div class="ml-0 md:ml-64 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Select Project Winner</h1>
                    <p class="text-gray-600 mt-2">Review final bids and select the winning bidder</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="px-4 py-2 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                        Round 2.5 - Winner Selection
                    </span>
                    <a href="/customer/project/<%= project._id %>" 
                       class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300">
                        Back to Project
                    </a>
                </div>
            </div>

            <%- include('../partials/flash-messages') %>

            <!-- Selection Info -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-8">
                <div class="flex items-center">
                    <i class="fas fa-trophy text-purple-500 text-xl mr-3"></i>
                    <div>
                        <h3 class="font-semibold text-purple-800">Final Round Completed</h3>
                        <p class="text-purple-700 mt-1">
                            Round 2 has ended. Review the final bids from the top 3 sellers and select the winner for your project.
                            The selected winner will proceed to the contract phase.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Final Bids Section -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-6">Final Bids from Top 3 Sellers</h2>

                <form id="winnerForm" action="/customer/project/<%= project._id %>/select-winner" method="POST">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    
                    <div class="grid gap-6 mb-8">
                        <% project.biddingRounds.round2.selectedBids.forEach((bid, index) => { %>
                            <div class="bg-white shadow rounded-lg p-6 border-2 border-gray-200 hover:border-purple-300 transition duration-300">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-start space-x-4 flex-1">
                                        <!-- Selection Radio -->
                                        <div class="flex items-start mt-1">
                                            <input type="radio" 
                                                   name="winningBid" 
                                                   value="<%= bid._id %>" 
                                                   id="bid-<%= bid._id %>"
                                                   class="h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300">
                                        </div>

                                        <!-- Bidder Info -->
                                        <div class="flex-1">
                                            <div class="flex items-center mb-2">
                                                <label for="bid-<%= bid._id %>" class="text-xl font-semibold text-gray-900 cursor-pointer">
                                                    <%= bid.seller.companyName || bid.seller.name %>
                                                </label>
                                                <span class="ml-3 px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">
                                                    FINAL BIDDER
                                                </span>
                                            </div>
                                            
                                            <!-- Rating and Experience -->
                                            <div class="flex items-center space-x-4 text-sm text-gray-600 mb-3">
                                                <% if (bid.seller.rating) { %>
                                                    <div class="flex items-center">
                                                        <i class="fas fa-star text-yellow-500 mr-1"></i>
                                                        <span><%= bid.seller.rating.toFixed(1) %> rating</span>
                                                    </div>
                                                <% } %>
                                                <% if (bid.seller.yearsOfExperience) { %>
                                                    <div class="flex items-center">
                                                        <i class="fas fa-briefcase text-blue-500 mr-1"></i>
                                                        <span><%= bid.seller.yearsOfExperience %> years experience</span>
                                                    </div>
                                                <% } %>
                                                <div class="flex items-center">
                                                    <i class="fas fa-tag text-purple-500 mr-1"></i>
                                                    <span class="capitalize"><%= bid.seller.specialization || 'General' %></span>
                                                </div>
                                            </div>

                                            <!-- Bid Comparison -->
                                            <div class="grid md:grid-cols-2 gap-4 text-sm mb-3">
                                                <div class="bg-blue-50 p-3 rounded-lg">
                                                    <p class="text-blue-700 font-semibold">Round 1 Bid</p>
                                                    <p class="text-2xl font-bold text-blue-800">$<%= bid.amount %></p>
                                                </div>
                                                <div class="bg-green-50 p-3 rounded-lg">
                                                    <p class="text-green-700 font-semibold">Final Round 2 Bid</p>
                                                    <p class="text-2xl font-bold text-green-800">$<%= bid.round2Bid.amount %></p>
                                                    <p class="text-xs text-green-600">
                                                        <% const change = (((bid.round2Bid.amount - bid.amount) / bid.amount) * 100).toFixed(1); %>
                                                        <%= change > 0 ? '+' : '' %><%= change %>% from Round 1
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Final Bid Amount -->
                                    <div class="text-right">
                                        <p class="text-3xl font-bold text-green-600">$<%= bid.round2Bid.amount %></p>
                                        <p class="text-sm text-gray-500">Final Bid Amount</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            Updated: <%= moment(bid.round2Bid.submittedAt).format('MMM D, h:mm A') %>
                                        </p>
                                    </div>
                                </div>

                                <!-- Proposal Comparison -->
                                <div class="mb-4">
                                    <h4 class="font-semibold text-gray-900 mb-2">Final Proposal</h4>
                                    <p class="text-gray-700 line-clamp-3"><%= bid.round2Bid.proposal || bid.proposal %></p>
                                    <% if (bid.round2Bid.proposal && bid.round2Bid.proposal !== bid.proposal) { %>
                                    <p class="text-xs text-blue-600 mt-1">
                                        <i class="fas fa-edit mr-1"></i>Updated from Round 1
                                    </p>
                                    <% } %>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex justify-between items-center border-t border-gray-100 pt-4">
                                    <div class="flex space-x-3">
                                        <a href="/customer/project/<%= project._id %>/bid/<%= bid._id %>/details" 
                                           class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 text-sm">
                                            <i class="fas fa-eye mr-2"></i>View Full Details
                                        </a>
                                        <a href="/customer/project/<%= project._id %>/bid/<%= bid._id %>/profile" 
                                           class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 text-sm">
                                            <i class="fas fa-user mr-2"></i>View Profile
                                        </a>
                                    </div>
                                    
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600">
                                            Revisions: <%= bid.round2Bid.revisionCount || 0 %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>

                    <!-- Selection Summary -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Select Winner</h3>
                                <p class="text-gray-600" id="selectionStatus">
                                    No bid selected yet
                                </p>
                            </div>
                            <div class="space-x-4">
                                <a href="/customer/project/<%= project._id %>" 
                                   class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition duration-300">
                                    Cancel
                                </a>
                                <button type="submit" 
                                        id="submitSelection"
                                        disabled
                                        class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-300 font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <i class="fas fa-crown mr-2"></i>
                                    Award Project to Selected Bidder
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Project Summary -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Project Summary</h2>
                <div class="grid md:grid-cols-3 gap-6">
                    <div>
                        <h3 class="font-semibold text-gray-900">Bidding Summary</h3>
                        <div class="mt-2 space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Total Bids Received:</span>
                                <span class="font-medium"><%= project.bids.length %></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Round 1 Top 10:</span>
                                <span class="font-medium"><%= project.round1Selections.top3.length + project.round1Selections.waitingQueue.length %></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Final Round Bidders:</span>
                                <span class="font-medium"><%= project.biddingRounds.round2.selectedBids.length %></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-gray-900">Bid Amount Range</h3>
                        <div class="mt-2 space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Lowest Final Bid:</span>
                                <span class="font-medium text-green-600">
                                    $<%= Math.min(...project.biddingRounds.round2.selectedBids.map(b => b.round2Bid.amount)) %>
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Highest Final Bid:</span>
                                <span class="font-medium text-green-600">
                                    $<%= Math.max(...project.biddingRounds.round2.selectedBids.map(b => b.round2Bid.amount)) %>
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Average Final Bid:</span>
                                <span class="font-medium text-green-600">
                                    $<%= (project.biddingRounds.round2.selectedBids.reduce((sum, b) => sum + b.round2Bid.amount, 0) / project.biddingRounds.round2.selectedBids.length).toFixed(2) %>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-gray-900">Next Steps</h3>
                        <div class="mt-2 space-y-2 text-sm text-gray-600">
                            <p>• Winner proceeds to contract phase</p>
                            <p>• Contract templates generated automatically</p>
                            <p>• Digital signing process begins</p>
                            <p>• Project execution starts after contract completion</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('winnerForm');
        const radioButtons = document.querySelectorAll('input[name="winningBid"]');
        const submitBtn = document.getElementById('submitSelection');
        const selectionStatus = document.getElementById('selectionStatus');

        // Update selection status
        function updateSelectionStatus() {
            const selectedBid = document.querySelector('input[name="winningBid"]:checked');
            if (selectedBid) {
                const bidElement = selectedBid.closest('.bg-white');
                const bidderName = bidElement.querySelector('.text-xl').textContent;
                const bidAmount = bidElement.querySelector('.text-3xl').textContent;
                
                selectionStatus.innerHTML = `Selected: <strong>${bidderName}</strong> with ${bidAmount}`;
                submitBtn.disabled = false;
            } else {
                selectionStatus.textContent = 'No bid selected yet';
                submitBtn.disabled = true;
            }
        }

        // Add event listeners to radio buttons
        radioButtons.forEach(radio => {
            radio.addEventListener('change', updateSelectionStatus);
        });

        // Form submission confirmation
        form.addEventListener('submit', function(e) {
            const selectedBid = document.querySelector('input[name="winningBid"]:checked');
            if (!selectedBid) {
                e.preventDefault();
                alert('Please select a winning bid before submitting.');
                return;
            }

            const bidElement = selectedBid.closest('.bg-white');
            const bidderName = bidElement.querySelector('.text-xl').textContent;
            const bidAmount = bidElement.querySelector('.text-3xl').textContent;

            const confirmed = confirm(`Are you sure you want to award the project to ${bidderName} with ${bidAmount}? This action cannot be undone.`);
            
            if (!confirmed) {
                e.preventDefault();
            } else {
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Awarding Project...';
                submitBtn.disabled = true;
            }
        });

        // Initialize selection status
        updateSelectionStatus();

        // Add visual feedback for selection
        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                // Remove previous selections
                document.querySelectorAll('.bg-white').forEach(card => {
                    card.classList.remove('border-purple-500', 'bg-purple-50');
                    card.classList.add('border-gray-200');
                });

                // Highlight selected card
                if (this.checked) {
                    const card = this.closest('.bg-white');
                    card.classList.remove('border-gray-200');
                    card.classList.add('border-purple-500', 'bg-purple-50');
                }
            });
        });
    });// Auto-refresh for real-time status updates
setInterval(() => {
    // Check if there are active bids/projects that need updates
    const hasActiveItems = document.querySelectorAll('[data-needs-refresh="true"]').length > 0;
    if (hasActiveItems) {
        console.log('Auto-refreshing for status updates...');
        location.reload();
    }
}, 30000);
    </script>
</body>
</html>