<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - Propload</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body class="bg-gray-50">
    <%- include('../partials/header') %>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <%- include('../partials/flash-messages') %>

        <!-- Hidden data container for chart data -->
        <div id="chartData" 
             data-drafted="<%= stats.drafted || 0 %>"
             data-in-progress="<%= stats['in-progress'] || 0 %>"
             data-half-partial="<%= stats['half-partial'] || 0 %>"
             data-full-partial="<%= stats['full-partial'] || 0 %>"
             data-half-completed="<%= stats['half-completed'] || 0 %>"
             data-completed="<%= stats.completed || 0 %>"
             data-failed="<%= stats.failed || 0 %>"
             style="display: none;">
        </div>

        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            <div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Dashboard</h2>
                <p class="text-gray-600 mt-2">Welcome back, <%= user.name %>! Here's your project overview.</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <a href="/customer/update-statuses" 
                   class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Update Statuses
                </a>
                <a href="/customer/add-project" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center shadow-lg hover:shadow-xl w-full sm:w-auto justify-center">
                    <i class="fas fa-plus mr-2"></i>
                    Add Project
                </a>
            </div>
        </div>

        <!-- Real-time Status Header -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-sync-alt text-blue-600 mr-2"></i>
                    <span class="text-sm text-blue-700">Automatic status updates active â€¢ Projects activate automatically on start date</span>
                </div>
                <div class="flex space-x-2">
                    <a href="/customer/update-statuses" 
                       class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition duration-300 flex items-center">
                        <i class="fas fa-sync-alt mr-1"></i>
                        Update Now
                    </a>
                    <span class="text-xs text-blue-600" id="last-updated">
                        Updated just now
                    </span>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-4 sm:p-6 border-l-4 border-blue-500 hover:shadow-lg transition duration-300">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-file-alt text-blue-600 text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <h3 class="text-xs sm:text-sm font-medium text-gray-500">Total Projects</h3>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800">
                            <%= typeof stats === 'object' ? Object.values(stats).reduce((a, b) => a + b, 0) : 0 %>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4 sm:p-6 border-l-4 border-green-500 hover:shadow-lg transition duration-300">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-play-circle text-green-600 text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <h3 class="text-xs sm:text-sm font-medium text-gray-500">In Progress</h3>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800">
                            <%= stats['in-progress'] || 0 %>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4 sm:p-6 border-l-4 border-yellow-500 hover:shadow-lg transition duration-300">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-tasks text-yellow-600 text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <h3 class="text-xs sm:text-sm font-medium text-gray-500">Completed</h3>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800">
                            <%= stats.completed || 0 %>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4 sm:p-6 border-l-4 border-red-500 hover:shadow-lg transition duration-300">
                <div class="flex items-center">
                    <div class="p-2 sm:p-3 bg-red-100 rounded-lg">
                        <i class="fas fa-times-circle text-red-600 text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-3 sm:ml-4">
                        <h3 class="text-xs sm:text-sm font-medium text-gray-500">Failed</h3>
                        <p class="text-xl sm:text-2xl font-bold text-gray-800">
                            <%= stats.failed || 0 %>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Pending Contracts Section -->
        <% if (pendingContracts && pendingContracts.length > 0) { %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-file-contract text-yellow-600 mr-2"></i>
                    <span class="text-sm text-yellow-700">
                        You have <%= pendingContracts.length %> pending contract(s) waiting for action
                    </span>
                </div>
                <a href="/customer/won-projects" 
                   class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition duration-300 flex items-center">
                    <i class="fas fa-eye mr-1"></i>
                    View Contracts
                </a>
            </div>
        </div>
        <% } %>

        <!-- Detailed Stats and Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <!-- Left Side - Latest Bids -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-gavel mr-2 text-indigo-600"></i>
                            Latest Bids
                        </h3>
                    </div>
                    <div class="p-4 sm:p-6">
                        <% if (latestBids && latestBids.length > 0) { %>
                            <div class="space-y-3 sm:space-y-4">
                                <% latestBids.forEach(bid => { %>
                                <div class="border border-gray-200 rounded-lg p-3 sm:p-4 hover:bg-gray-50 transition duration-300">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-gray-800 truncate text-xs sm:text-sm flex-1 mr-2">
                                            <%= bid.project && bid.project.title ? bid.project.title : 'Project' %>
                                        </h4>
                                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded whitespace-nowrap">
                                            $<%= bid.amount ? bid.amount.toLocaleString() : '0' %>
                                        </span>
                                    </div>
                                    
                                    <!-- Seller info with profile image -->
                                    <div class="flex items-center space-x-2 mb-2">
                                        <% if (bid.seller && bid.seller.profileImage && bid.seller.profileImage.url) { %>
                                        <img src="<%= bid.seller.profileImage.url %>" 
                                             alt="<%= bid.seller.companyName || bid.seller.name %>"
                                             class="w-6 h-6 rounded-full object-cover">
                                        <% } else { %>
                                        <div class="w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center">
                                            <i class="fas fa-user text-gray-600 text-xs"></i>
                                        </div>
                                        <% } %>
                                        <p class="text-xs text-gray-600">
                                            By: <%= bid.seller ? (bid.seller.companyName || bid.seller.name || 'Unknown Seller') : 'Unknown Seller' %>
                                        </p>
                                    </div>
                                    
                                    <p class="text-xs text-gray-500">
                                        <%= bid.createdAt ? new Date(bid.createdAt).toLocaleDateString() : 'Unknown date' %>
                                    </p>
                                    <div class="bid-status mt-2">
                                        <% if (bid.status === 'submitted') { %>
                                            <span class="text-xs text-blue-600">Pending</span>
                                        <% } else if (bid.status === 'won') { %>
                                            <span class="text-xs text-green-600 font-semibold">Won</span>
                                        <% } else if (bid.status === 'lost') { %>
                                            <span class="text-xs text-red-600">Lost</span>
                                        <% } %>
                                    </div>
                                </div>
                                <% }) %>
                            </div>
                            <div class="mt-4 text-center">
                                <a href="/customer/my-projects" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                    View All Projects <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        <% } else { %>
                            <div class="text-center py-6">
                                <i class="fas fa-gavel text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-500">No bids yet</p>
                                <p class="text-sm text-gray-400 mt-1">Bids will appear here when sellers respond to your projects</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Middle - Status Breakdown -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-indigo-600"></i>
                            Project Status
                        </h3>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div class="h-64">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-bolt mr-2 text-indigo-600"></i>
                            Quick Actions
                        </h3>
                    </div>
                    <div class="p-4 sm:p-6 grid grid-cols-2 gap-3 sm:gap-4">
                        <a href="/customer/add-project" 
                           class="bg-indigo-50 text-indigo-700 p-3 sm:p-4 rounded-lg text-center hover:bg-indigo-100 transition duration-300 group">
                            <i class="fas fa-plus text-lg mb-2 block group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs sm:text-sm font-medium">New Project</span>
                        </a>
                        <a href="/customer/my-projects" 
                           class="bg-green-50 text-green-700 p-3 sm:p-4 rounded-lg text-center hover:bg-green-100 transition duration-300 group">
                            <i class="fas fa-list text-lg mb-2 block group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs sm:text-sm font-medium">My Projects</span>
                        </a>
                        <a href="/customer/won-projects" 
                           class="bg-blue-50 text-blue-700 p-3 sm:p-4 rounded-lg text-center hover:bg-blue-100 transition duration-300 group">
                            <i class="fas fa-trophy text-lg mb-2 block group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs sm:text-sm font-medium">Won Projects</span>
                        </a>
                        <a href="/customer/notices" 
                           class="bg-purple-50 text-purple-700 p-3 sm:p-4 rounded-lg text-center hover:bg-purple-100 transition duration-300 group">
                            <i class="fas fa-bell text-lg mb-2 block group-hover:scale-110 transition-transform"></i>
                            <span class="text-xs sm:text-sm font-medium">Notices</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Side - Latest Notices -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-bell mr-2 text-indigo-600"></i>
                            Latest Notices
                        </h3>
                    </div>
                    <div class="p-4 sm:p-6">
                        <% if (latestNotices && latestNotices.length > 0) { %>
                            <div class="space-y-3 sm:space-y-4">
                                <% latestNotices.forEach(notice => { %>
                                <div class="border-l-4 border-indigo-500 pl-3 sm:pl-4 py-2 hover:bg-gray-50 transition duration-300 cursor-pointer" 
                                     onclick="window.location.href='/customer/notices'">
                                    <h4 class="font-semibold text-gray-800 text-xs sm:text-sm mb-1">
                                        <%= notice.title %>
                                    </h4>
                                    <p class="text-xs text-gray-600 mb-2">
                                        <%= notice.content ? notice.content.substring(0, 80) + (notice.content.length > 80 ? '...' : '') : 'No content' %>
                                    </p>
                                    <p class="text-xs text-gray-500 flex items-center">
                                        <i class="fas fa-clock mr-1"></i>
                                        <%= notice.createdAt ? new Date(notice.createdAt).toLocaleDateString() : 'Unknown date' %>
                                    </p>
                                </div>
                                <% }) %>
                            </div>
                            <div class="mt-4 text-center">
                                <a href="/customer/notices" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                    View All Notices <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        <% } else { %>
                            <div class="text-center py-6">
                                <i class="fas fa-bell-slash text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-500">No notices</p>
                                <p class="text-sm text-gray-400 mt-1">Important updates will appear here</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Status Chart
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('statusChart');
            if (ctx) {
                const dataElement = document.getElementById('chartData');
                
                const statusData = {
                    'Drafted': parseInt(dataElement.getAttribute('data-drafted')) || 0,
                    'In Progress': parseInt(dataElement.getAttribute('data-in-progress')) || 0,
                    'Half Partial': parseInt(dataElement.getAttribute('data-half-partial')) || 0,
                    'Full Partial': parseInt(dataElement.getAttribute('data-full-partial')) || 0,
                    'Half Completed': parseInt(dataElement.getAttribute('data-half-completed')) || 0,
                    'Completed': parseInt(dataElement.getAttribute('data-completed')) || 0,
                    'Failed': parseInt(dataElement.getAttribute('data-failed')) || 0
                };

                console.log('Chart Data loaded:', statusData);

                // Filter out statuses with 0 values for cleaner chart
                const filteredLabels = [];
                const filteredData = [];
                const filteredColors = [
                    '#fbbf24', // yellow - Drafted
                    '#3b82f6', // blue - In Progress  
                    '#8b5cf6', // purple - Half Partial
                    '#ec4899', // pink - Full Partial
                    '#10b981', // emerald - Half Completed
                    '#059669', // green - Completed
                    '#ef4444'  // red - Failed
                ];

                Object.keys(statusData).forEach((key, index) => {
                    if (statusData[key] > 0) {
                        filteredLabels.push(key);
                        filteredData.push(statusData[key]);
                    }
                });

                // If no data, show empty state
                if (filteredData.length === 0) {
                    filteredLabels.push('No Projects');
                    filteredData.push(1);
                    filteredColors.length = 0;
                    filteredColors.push('#9ca3af'); // gray for empty state
                }

                // Create the chart
                const statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: filteredLabels,
                        datasets: [{
                            data: filteredData,
                            backgroundColor: filteredColors,
                            borderWidth: 2,
                            borderColor: '#ffffff',
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 11
                                    },
                                    color: '#374151'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%',
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });

                // Add resize observer to handle chart resizing
                const resizeObserver = new ResizeObserver(entries => {
                    statusChart.resize();
                });
                resizeObserver.observe(ctx.parentElement);
            }

            // Update last updated timestamp
            setInterval(() => {
                const now = new Date();
                const lastUpdated = document.getElementById('last-updated');
                if (lastUpdated) {
                    lastUpdated.textContent = 'Updated ' + moment(now).fromNow();
                }
            }, 60000);
        });

        // Auto-refresh page every 30 seconds for real-time updates
        setInterval(() => {
            location.reload();
        }, 30000);
    </script>

    <%- include('../partials/footer') %>
</body>
</html>