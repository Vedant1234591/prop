<!-- views/partials/header.ejs -->

<%
  // Set default values if variables are not provided
  if (typeof currentPage === 'undefined') currentPage = '';
  if (typeof bidCount === 'undefined') bidCount = 0;
  if (typeof messageCount === 'undefined') messageCount = 0;
  if (typeof user === 'undefined') user = {};
%>


<nav class="bg-white shadow-lg">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center py-4">
      <div class="flex items-center">
        <a href="/" class="text-2xl font-bold text-indigo-600">Propload</a>
        <% if (user && user.role) { %>
        <span
          class="ml-4 px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm capitalize"
        >
          <%= user.role %>
        </span>
        <% } %>
      </div>
      <div class="flex items-center space-x-4">
        <% if (user && user._id) { %> <% if (user.role === 'customer') { %>
        <a
          href="/customer/update-statuses"
          class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 flex items-center"
        >
          <i class="fas fa-sync-alt mr-2"></i>
          Update Statuses
        </a>
        <a
          href="/customer/dashboard"
          class="text-gray-600 hover:text-indigo-600 transition duration-300 <%= currentPage === 'dashboard' ? 'text-indigo-600 font-semibold' : '' %>"
        >
          Dashboard
        </a>
        <a
          href="/customer/my-projects"
          class="text-gray-600 hover:text-indigo-600 transition duration-300 <%= currentPage === 'projects' ? 'text-indigo-600 font-semibold' : '' %>"
        >
          My Projects
        </a>
        <a
          href="/customer/bids"
          class="text-gray-600 hover:text-indigo-600 transition duration-300 <%= currentPage === 'bids' ? 'text-indigo-600 font-semibold' : '' %>"
        >
          Bids <% if (bidCount > 0) { %>
          <span
            class="ml-1 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center inline-flex"
          >
            <%= bidCount %>
          </span>
          <% } %>
        </a>
        <a
          href="/customer/messages"
          class="text-gray-600 hover:text-indigo-600 transition duration-300 <%= currentPage === 'messages' ? 'text-indigo-600 font-semibold' : '' %>"
        >
          Messages <% if (messageCount > 0) { %>
          <span
            class="ml-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center inline-flex"
          >
            <%= messageCount %>
          </span>
          <% } %>
        </a>
        <% } else if (user.role === 'seller') { %>
        <a
          href="/seller/update-statuses"
          class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition duration-300 mr-2"
        >
          <i class="fas fa-sync-alt mr-1"></i>Update
        </a>

        <a
          href="/seller/dashboard"
          class="text-gray-600 hover:text-indigo-600 transition duration-300 <%= currentPage === 'dashboard' ? 'text-indigo-600 font-semibold' : '' %>"
        >
          Dashboard
        </a>
        <a
          href="/seller/find-bids"
          class="text-gray-600 hover:text-indigo-600 transition duration-300 <%= currentPage === 'find-bids' ? 'text-indigo-600 font-semibold' : '' %>"
        >
          Find Bids
        </a>
        <a
          href="/seller/my-bids"
          class="text-gray-600 hover:text-indigo-600 transition duration-300 <%= currentPage === 'my-bids' ? 'text-indigo-600 font-semibold' : '' %>"
        >
          My Bids <% if (bidCount > 0) { %>
          <span
            class="ml-1 bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center inline-flex"
          >
            <%= bidCount %>
          </span>
          <% } %>
        </a>
        <% } %>

        <div class="relative group">
          <button
            class="flex items-center space-x-2 text-gray-600 hover:text-indigo-600 transition duration-300 px-3 py-2 rounded-lg hover:bg-gray-50"
          >
            <!-- Cloudinary Profile Image -->
            <div class="flex items-center space-x-2">
              <% if (user.profileImage && user.profileImage.url) { %>
              <img
                class="h-8 w-8 rounded-full object-cover border-2 border-white shadow-sm"
                src="<%= user.profileImage.url %>"
                alt="<%= user.name %>"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
              />
              <% } %>

              <!-- Fallback avatar -->
              <div
                class="h-8 w-8 bg-indigo-600 rounded-full flex items-center justify-center border-2 border-white shadow-sm <%= (user.profileImage && user.profileImage.url) ? 'hidden' : '' %>"
              >
                <i class="fas fa-user text-white text-sm"></i>
              </div>

              <span class="font-medium"><%= user.name %></span>
            </div>
            <svg
              class="w-4 h-4 transform group-hover:rotate-180 transition duration-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>
          <div
            class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 hidden group-hover:block z-50 border border-gray-200"
          >
            <!-- User Info -->
            <div class="px-4 py-2 border-b border-gray-100">
              <p class="text-sm font-medium text-gray-900 truncate">
                <%= user.name %>
              </p>
              <p class="text-xs text-gray-500 truncate"><%= user.email %></p>
            </div>

            <!-- Navigation Links -->
            <div class="py-1">
              <% if (user.role === 'customer') { %>
              <a
                href="/customer/dashboard"
                class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
              >
                <i class="fas fa-tachometer-alt w-4 mr-3 text-gray-400"></i>
                Dashboard
              </a>
              <a
                href="/customer/profile"
                class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
              >
                <i class="fas fa-user w-4 mr-3 text-gray-400"></i>
                Profile
              </a>
              <a
                href="/customer/my-projects"
                class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
              >
                <i class="fas fa-list w-4 mr-3 text-gray-400"></i>
                My Projects
              </a>
              <% } else if (user.role === 'seller') { %>
              <a
                href="/seller/dashboard"
                class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
              >
                <i class="fas fa-tachometer-alt w-4 mr-3 text-gray-400"></i>
                Dashboard
              </a>
              <a
                href="/seller/profile"
                class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
              >
                <i class="fas fa-user w-4 mr-3 text-gray-400"></i>
                Profile
              </a>
              <a
                href="/seller/my-bids"
                class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
              >
                <i class="fas fa-gavel w-4 mr-3 text-gray-400"></i>
                My Bids
              </a>
              <% } %>

              <div class="border-t border-gray-100 my-1"></div>

              <a
                href="/<%= user.role %>/settings"
                class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
              >
                <i class="fas fa-cog w-4 mr-3 text-gray-400"></i>
                Settings
              </a>
              <form action="/auth/logout" method="POST" class="w-full">
                <button
                  type="submit"
                  class="flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-300"
                >
                  <i class="fas fa-sign-out-alt w-4 mr-3 text-gray-400"></i>
                  Logout
                </button>
              </form>
            </div>
          </div>
        </div>
        <% } else { %>
        <a
          href="/auth/login"
          class="text-gray-600 hover:text-indigo-600 transition duration-300"
          >Login</a
        >
        <a
          href="/auth/register?role=customer"
          class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-300"
          >Get Started</a
        >
        <% } %>
      </div>
    </div>
  </div>
</nav>

<script>
  // Handle profile image loading errors
  document.addEventListener("DOMContentLoaded", function () {
    const profileImages = document.querySelectorAll("img[onerror]");
    profileImages.forEach((img) => {
      img.addEventListener("error", function () {
        this.style.display = "none";
        const fallback = this.nextElementSibling;
        if (fallback && fallback.classList.contains("hidden")) {
          fallback.style.display = "flex";
        }
      });
    });
  });

  // Simple dropdown functionality - FIXED VERSION
  document.addEventListener("DOMContentLoaded", function () {
    const dropdownButtons = document.querySelectorAll(".group > button");

    dropdownButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const dropdown = this.closest(".group");
        const menu = dropdown.querySelector(".hidden");

        // Close all other dropdowns
        document.querySelectorAll(".group .hidden").forEach((otherMenu) => {
          if (otherMenu !== menu) {
            otherMenu.classList.add("hidden");
          }
        });

        // Toggle current dropdown
        if (menu) {
          menu.classList.toggle("hidden");
        }
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", function (event) {
      if (!event.target.closest(".group")) {
        document.querySelectorAll(".group .hidden").forEach((menu) => {
          menu.classList.add("hidden");
        });
      }
    });
  });

  // Alternative: If you want hover functionality instead of click, use this:
  /*
document.addEventListener('DOMContentLoaded', function() {
    const dropdowns = document.querySelectorAll('.group');
    
    dropdowns.forEach(dropdown => {
        dropdown.addEventListener('mouseenter', function() {
            const menu = this.querySelector('.hidden');
            if (menu) {
                menu.classList.remove('hidden');
            }
        });
        
        dropdown.addEventListener('mouseleave', function() {
            const menu = this.querySelector('.hidden');
            if (menu && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
            }
        });
    });
});
*/
</script>
